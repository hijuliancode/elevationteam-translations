#!/usr/bin/env node
"use strict";var o=require("fs"),e=require("path"),n=require("readline"),s=require("openai"),t=require("dotenv"),r=require("chokidar");t.config();const a=new s.OpenAI({apiKey:process.env.OPENAI_API_KEY});async function c(o,e,n){const s={...e};for(const[t,r]of Object.entries(o))if("string"!=typeof r||e[t]&&e[t]===r)"object"==typeof r&&(s[t]=await c(r,e[t],n));else try{const o=await i(r,n);s[t]=o}catch(o){console.error(`Error translating key: ${t} to ${n}: ${o.message}`)}return s}async function i(o,e){try{const n=await a.chat.completions.create({model:"gpt-3.5-turbo-0125",messages:[{role:"system",content:`You are a professional translator. Translate the following text to ${e}:`},{role:"user",content:o}],temperature:.3,max_tokens:100});return console.log("---"),console.log("response",n),console.log("---"),console.log("response.choices",n.choices),console.log("---"),console.log("response.choices[0]",n.choices[0]),console.log("---"),console.log("response.choices[0]?.message",n.choices[0]?.message),console.log("---"),n.choices[0]?.message?.content?.trim()||o}catch(e){return console.error("Error translating text:",e.message),o}}const l=e.join(process.cwd(),"translations.config.js");async function g(){try{return o.existsSync(l)||(console.log("Error: translations.config.js not found."),process.exit(1)),(await import(l)).translationConfig}catch(o){console.error("Error loading configuration: ",o.message),process.exit(1)}}async function u(n){const{defaultLanguage:s,targetLanguages:t,inputDir:r,outputDir:a}=n,i=e.join(process.cwd(),r,`${s}.json`);o.existsSync(i)||(console.error(`Error: Base translation file not found at ${i}`),process.exit(1));try{const n=JSON.parse(o.readFileSync(i,"utf-8"));for(const r of t){if(r===s)continue;const t=e.join(process.cwd(),a,`${r}.json`);let i={};o.existsSync(t)&&(i=JSON.parse(o.readFileSync(t,"utf-8")));const l=await c(n,i,r);o.writeFileSync(t,JSON.stringify(l,null,2)),console.log(`Translations updated for ${r} at ${t}`)}}catch(o){console.error("Error processing translations: ",o.message),process.exit(1)}}const p=n.createInterface({input:process.stdin,output:process.stdout});function f(o){return new Promise((e=>p.question(o,e)))}const[,,y]=process.argv;"init"===y?async function(){console.log("Welcome to the ElevationTeam Translation CLI!");const n=e.join(process.cwd(),"package.json");o.existsSync(n)||(console.error("Error: package.json not found. Please ensure you are in a Node.js project."),process.exit(1));const s=JSON.parse(o.readFileSync(n,"utf-8"));if(o.existsSync(l)){const e=await f("Config file already exists at translations.config.js, do you want to overwrite it?: (no) ")||"n";"yes"!==e.toLowerCase()&&"y"!==e.toLowerCase()&&(console.log("Exiting..."),process.exit(0)),o.unlinkSync(l)}let t=await f("Enter the base language: (en) ")||"en";const r=(await f("Enter target locales separated by space or comma: (es) ")||"es").split(/[\s,]+/).filter((o=>o));let a=await f("Enter the input directory when the baseFile is located: (src/translations) ")||"src/translations",c=await f("Enter the output directory for generated translation files: (src/translations) ")||"src/translations";const i=`export const translationConfig = {\n  defaultLanguage: '${t}', // Base language for translations\n  languages: [${g=r,console.log("formatting languages..."),g.filter(((o,e)=>o!==t&&g.indexOf(o)===e)).map((o=>`'${o}'`))}], // Target languages for translations\n  inputDir: '${a}', // Directory where is the base translation file\n  outputDir: '${c}', // Directory for the generated translation files\n}\n`;var g;"y"!==(await f(`About to write to ${l}:\n${i}\nIs this OK? (yes) `)||"y").toLowerCase()&&(console.log("Aborted."),process.exit(0)),o.writeFileSync(l,i),console.log("Config file created successfully at translations.config.js"),s.scripts=s.scripts||{},s.scripts["translation:run"]?console.log('Script "translation:run" already exists in package.json'):(s.scripts["translation:run"]="et-translations run",console.log('Script "translation:run" added to package.json')),s.scripts["translation:watch"]?console.log('Script "translation:watch" already exists in package.json'):(s.scripts["translation:watch"]="et-translations watch",console.log('Script "translation:watch" added to package.json')),o.writeFileSync(n,JSON.stringify(s,null,2)),p.close()}():"run"===y?g().then((o=>async function(o){await u(o)}(o))):"watch"===y?g().then((n=>async function(n){const{defaultLanguage:s,inputDir:t}=n,a=e.join(process.cwd(),t,`${s}.json`);o.existsSync(a)||(console.error(`Error: Base translation file not found at ${a}`),process.exit(1)),r.watch(a).on("change",(async()=>{console.log("Translation file changed. Processing translations...");try{await u(n),console.log("Translations processed successfully.")}catch(o){console.error("Error processing translations: ",o.message)}console.log(`Watching for changes in ${a}`)}))}(n))):(console.log('Unknown command. Use "init", "run", or "watch".'),process.exit(1));
