#!/usr/bin/env node
"use strict";var e=require("fs"),n=require("path"),o=require("readline"),t=require("openai"),s=require("chokidar");const a=new t.OpenAI({apiKey:process.env.OPENAI_API_KEY});async function r(e,n,o){const t={...n};for(const[s,a]of Object.entries(e))if("string"!=typeof a||n[s]&&n[s]===a)"object"==typeof a&&(t[s]=await r(a,n[s],o));else try{const e=await i(a,o);t[s]=e}catch(e){console.error(`Error translating key: ${s} to ${o}: ${e.message}`)}return t}async function i(e,n){const o=await a.chat.completions.create({model:"gpt-3.5-turbo-0125",messages:[{role:"system",content:`You are a professional translator. Translate the following text to ${n}:`},{role:"user",content:e}],temperature:.3,max_tokens:100});return console.log("---"),console.log("response",o),console.log("---"),console.log("response.choices",o.choices),console.log("---"),console.log("response.choices[0]",o.choices[0]),console.log("---"),console.log("response.choices[0]?.message",o.choices[0]?.message),console.log("---"),o.choices[0]?.message?.content?.trim()||e}const c=n.join(process.cwd(),"translation.config.js");async function l(){try{return e.existsSync(c)||(console.log("Error: translation.config.js not found."),process.exit(1)),(await import(c)).translationConfig}catch(e){console.error("Error loading configuration: ",e.message),process.exit(1)}}async function g(o){const{defaultLanguage:t,targetLanguages:s,inputDir:a,outputDir:i,format:c,aiProvider:l}=o,g=n.join(process.cwd(),a,`${t}.${c}`);e.existsSync(g)||(console.error(`Error: Base translation file not found at ${g}`),process.exit(1));try{const o=JSON.parse(e.readFileSync(g,"utf-8"));for(const a of s){if(a===t)continue;const s=n.join(process.cwd(),i,`${a}.${c}`);let l={};e.existsSync(s)&&(l=JSON.parse(e.readFileSync(s,"utf-8")));await r(o,l,a)}}catch(e){console.error("Error processing translations: ",e.message),process.exit(1)}}const u=o.createInterface({input:process.stdin,output:process.stdout});function p(e){return new Promise((n=>u.question(e,n)))}const[,,f]=process.argv;"init"===f?async function(){console.log("Welcome to the Elevation Team Translation CLI!");let o=await p("Enter the base language (en): ")||"en";const t=(await p("Enter target locales separated by space or comma (es): ")||"es").split(/[\s,]+/).filter((e=>e));if(t.includes(o))return console.log("Warning: The base language is included in the target languages. Removing it from the target languages..."),void t.splice(t.indexOf(o),1);if(1===t.length&&t[0]===o)return void console.log("Warning: The target language is the same as the base language. Please select a different target language.");let s=await p("Enter the input directory when the baseFile is located (src/translations): ")||"src/translations",a=await p("Enter the output directory for generated translation files (src/translations): ")||"src/translations",r=await p("Enter the output format js or json (json): ")||"json";if(e.existsSync(c))return void console.log("Config file already exists at translation.config.js");const i=`\nexport const translationConfig = {\n  defaultLanguage: '${o}', // Base language for translations\n  languages: ['${o}', ${t.map((e=>`'${e}'`)).join(", ")}], // Target languages for translations\n  inputDir: '${s}', // Directory for the base translation files\n  outputDir: '${a}', // Directory for the generated translation files\n  format: '${r}', // Output format (e.g., json, js)\n  aiProvider: 'openai', // AI provider for translations\n}\n\n`;e.writeFileSync(c,i),console.log("Config file created successfully at translation.config.js");const l=n.join(process.cwd(),"package.json");if(!e.existsSync(l))return void console.error("Error: package.json not found. Please ensure you are in a Node.js project.");const g=JSON.parse(e.readFileSync(l,"utf-8"));g.scripts=g.scripts||{},g.scripts["translation:run"]?console.log('Script "translation:run" already exists in package.json'):(g.scripts["translation:run"]="et-translations run",console.log('Script "translation:run" added to package.json')),g.scripts["translation:watch"]?console.log('Script "translation:watch" already exists in package.json'):(g.scripts["translation:watch"]="et-translations watch",console.log('Script "translation:watch" added to package.json')),e.writeFileSync(l,JSON.stringify(g,null,2)),u.close()}():"run"===f?l().then((e=>async function(e){await g(e)}(e))):"watch"===f?l().then((o=>async function(o){const{defaultLanguage:t,inputDir:a,format:r}=o,i=n.join(process.cwd(),a,`${t}.${r}`);e.existsSync(i)||(console.error(`Error: Base translation file not found at ${i}`),process.exit(1)),s.watch(i).on("change",(async()=>{console.log("Translation file changed. Processing translations...");try{await g(o),console.log("Translations processed successfully.")}catch(e){console.error("Error processing translations: ",e.message)}console.log(`Watching for changes in ${i}`)}))}(o))):(console.log('Unknown command. Use "init", "run", or "watch".'),process.exit(1));
